/*! grafana - v4.1.2 - 2017-02-13
 * Copyright (c) 2017 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["./query_def"],function(a){"use strict";function b(a){this.timeField=a.timeField,this.esVersion=a.esVersion}return b.prototype.getRangeFilter=function(){var a={};return a[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},a},b.prototype.buildTermsAgg=function(a,b,c){var d,e,f;if(b.terms={field:a.field},!a.settings)return b;if(b.terms.size=0===parseInt(a.settings.size,10)?500:parseInt(a.settings.size,10),void 0!==a.settings.orderBy&&(b.terms.order={},b.terms.order[a.settings.orderBy]=a.settings.order,d=parseInt(a.settings.orderBy,10),!isNaN(d)))for(f=0;f<c.metrics.length;f++)if(e=c.metrics[f],e.id===a.settings.orderBy){b.aggs={},b.aggs[e.id]={},b.aggs[e.id][e.type]={field:e.field};break}return a.settings.missing&&(b.terms.missing=a.settings.missing),b},b.prototype.getDateHistogramAgg=function(a){var b={},c=a.settings||{};return b.interval=c.interval,b.field=this.timeField,b.min_doc_count=c.min_doc_count||0,b.extended_bounds={min:"$timeFrom",max:"$timeTo"},b.format="epoch_millis","auto"===b.interval&&(b.interval="$interval"),c.missing&&(b.missing=c.missing),b},b.prototype.getFiltersAgg=function(a){for(var b={},c=0;c<a.settings.filters.length;c++){var d=a.settings.filters[c].query;b[d]={query_string:{query:d,analyze_wildcard:!0}}}return b},b.prototype.documentQuery=function(a){return a.size=500,a.sort={},a.sort[this.timeField]={order:"desc",unmapped_type:"boolean"},this.esVersion<5&&(a.fields=["*","_source"]),a.script_fields={},a.fielddata_fields=[this.timeField],a},b.prototype.addAdhocFilters=function(a,b){if(b){var c,d,e;for(c=0;c<b.length;c++)d=b[c],e={},e[d.key]=d.value,a.query.bool.must.push({term:e})}},b.prototype.build=function(b,c){b.metrics=b.metrics||[{type:"count",id:"1"}],b.dsType="elasticsearch",b.bucketAggs=b.bucketAggs||[{type:"date_histogram",id:"2",settings:{interval:"auto"}}],b.timeField=this.timeField;var d,e,f,g={size:0,query:{bool:{must:[{range:this.getRangeFilter()},{query_string:{analyze_wildcard:!0,query:"$lucene_query"}}]}}};if(this.addAdhocFilters(g,c),0===b.bucketAggs.length){if(f=b.metrics[0],f&&"raw_document"!==f.type)throw{message:"Invalid query"};return this.documentQuery(g,b)}for(e=g,d=0;d<b.bucketAggs.length;d++){var h=b.bucketAggs[d],i={};switch(h.type){case"date_histogram":i.date_histogram=this.getDateHistogramAgg(h);break;case"filters":i.filters={filters:this.getFiltersAgg(h)};break;case"terms":this.buildTermsAgg(h,i,b);break;case"geohash_grid":i.geohash_grid={field:h.field,precision:h.settings.precision}}e.aggs=e.aggs||{},e.aggs[h.id]=i,e=i}for(e.aggs={},d=0;d<b.metrics.length;d++)if(f=b.metrics[d],"count"!==f.type){var j={},k=null;if(a.isPipelineAgg(f.type)){if(!f.pipelineAgg||!/^\d*$/.test(f.pipelineAgg))continue;k={buckets_path:f.pipelineAgg}}else k={field:f.field};for(var l in f.settings)f.settings.hasOwnProperty(l)&&null!==f.settings[l]&&(k[l]=f.settings[l]);j[f.type]=k,e.aggs[f.id]=j}return g},b.prototype.getTermsQuery=function(a){var b={size:0,query:{bool:{must:[{range:this.getRangeFilter()}]}}};return a.query&&b.query.bool.must.push({query_string:{analyze_wildcard:!0,query:a.query}}),b.aggs={1:{terms:{field:a.field,size:500,order:{_term:"asc"}}}},b},b});